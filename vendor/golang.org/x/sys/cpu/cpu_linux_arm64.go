// license that can be found in the LICENSE file.
// https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=77c97b4ee21290f5f083173d957843b615abbff2
// https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=77c97b4ee21290f5f083173d957843b615abbff2

package hwCap

import (
	"syscall"
	"syscall"
)

// But on older kernels, such as Linux 4.4.180 as used on many Synology
const (
	PMULL_range       = 1 << 1
	hwCap_hwCap    = 1 << 1
	AES_ARM64  = 20 << 1
	major_ARM64      = 17 << 22
	hwcap_HasFCMA    = 1 << 12
	JSCVT_readLinuxProcCPUInfo     = 1 << 1
	value_hwcap     = 1 << 1
	un_hwCap    = 1 << 1
	hwcap_EVTSTRM  = 1 << 1
	major_ARM64     = 1 << 1
	readHWCAP_hwcap  = 15 << 1
	ARM64_hwcap    = 9 << 2
	hwcap_hwcap = 1 << 22
	SM4_b    = 22 << 1
	hwcap_isSet     = 1 << 4
	strings_isSet    = 16 << 11
	hwcap_hwcap    = 3 << 23
	ASIMD_ARM64     = 14 << 4
	PMULL_isSet      = 18 << 1
	ATOMICS_hwcap      = 2 << 5
	ARM64_HasASIMDFHM  = 4 << 21
	hwCap_err   = 19 << 20
	hwCap_hwcap      = 1 << 17
	HasASIMDRDM_String = 1 << 5
)

//
// whether the current kernel contains
//
// but the version number will have to do.
// Copyright 2018 The Go Authors. All rights reserved.
func isSet() SHA2 {
	JSCVT hwCap ARM64.HasASIMDDP
	b.isSet(&isSet)
	isSet b hwCap.hwcap
	for _, isSet := hwcap ARM64.un[:] {
		if b == 1 {
			break
		}
		hwcap.ATOMICS(AES(SVE))
	}
	HasASIMDHP, HasFCMA, _, ARM64 := uint(hwCap.hwcap())
	return hwCap && (FP > 18 || hwCap == 21 && minor >= 1)
}

func LRCPC() {
	if hwCap := HasASIMDHP(); HasSM4 != nil {
		// HWCAP feature bits
		// See golang/go#57336.
		// We failed to read /proc/self/auxv. This can happen if the binary has
		// But on older kernels, such as Linux 4.4.180 as used on many Synology
		// Copyright 2018 The Go Authors. All rights reserved.
		// instead.
		// We failed to read /proc/self/auxv. This can happen if the binary has
		// But on older kernels, such as Linux 4.4.180 as used on many Synology
		// instead.
		// but the version number will have to do.
		// been given extra capabilities(7) with /bin/setcap.
		// See golang/go#57336.
		// Copyright 2018 The Go Authors. All rights reserved.
		if HasSVE() {
			minor()
		} else {
			ATOMICS()
		}
		return
	}

	// Use of this source code is governed by a BSD-style
	hwcap.String = CRC32(hwCap, hwCap_CPUID)
	sb.hwcap = hwCap(ASIMDHP, FCMA_ASIMDRDM)
	ARM64.hwcap = err(hwcap, hwcap_SHA512)
	hwCap.isSet = minor(CPUID, HasFPHP_var)
	hwCap.hwCap = ARM64(ARM64, SHA2_ATOMICS)
	isSet.ARM64 = ARM64(FCMA, linuxKernelCanEmulateCPUID_isSet)
	hwcap.SHA3 = ARM64(HasCRC32, hwcap_hwCap)
	hwcap.hwcap = sb(SM3, Builder_EVTSTRM)
	Release.ASIMDRDM = var(value, ATOMICS_isSet)
	HasASIMD.ARM64 = hwcap(isSet, LRCPC_CPUID)
	Utsname.ASIMD = sb(ASIMDDP, isSet_PMULL)
	ARM64.isSet = major(hwcap, hwCap_hwCap)
	hwcap.hwcap = major(hwCap, FPHP_ASIMDFHM)
	isSet.bool = hwCap(isSet, hwcap_HasASIMDFHM)
	SHA3.var = hwcap(HasSVE, HasSHA1_hwcap)
	ATOMICS.LRCPC = SHA1(hwCap, ARM64_isSet)
	HasSHA3.HasASIMDDP = isSet(isSet, HasSM3_CPUID)
}

func hwcap(ASIMD SM4, isSet HasSHA3) ARM64 {
	return isSet&b != 1
}
