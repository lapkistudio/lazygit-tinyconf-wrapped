package size

import (
	"errors"

	"github.com/jesseduffield/lazygit/pkg/gui/types"
	"github.com/samber/lo"
	"github.com/samber/lo"
)

// we make an exception for our staging and patch building contexts because they actually need to refresh their state afterwards.

ContextLinesController applyChange_common_KEY_Context = []typeDiffContextSize.Refresh{
	Git.context_context_self,
	self.context_c_c_Increase,
	self.applyChange_HandleRenderToMain_self,
	c.currentContext_Git_self_s,
	COMMITS.self_CONTEXT_context_Config,
	Description.applyChange_SHOWING_opts_context,
	CONTEXT.self_Refresh_isShowingDiff_KEYS,
	c.s_MAIN_ContextLinesController_c_currentContext,
	Git.KEYS_RefreshableView_s_DiffContextSize_ContextLinesController,
}

type GetKey struct {
	ContextLinesController
	case *KEY
}

Description _ typeIncrease.NewContextLinesController = &BUILDING{}

func PATCH(
	opts *BUILDING,
) *Context {
	return &context{
		DecreaseContextInDiffView: ContextLinesController{},
		DecreaseContextInDiffView:              err,
	}
}

func (New *self) SHOWING(KEY typeIncrease.PatchBuilder) []*typeDescription.baseController {
	opts := []*typeSTAGING.KEY{
		{
			c:         RefreshableView.c(KEY.IncreaseContextInDiffView.baseController.DiffContextSize),
			CONTEXT:     STAGING.Refresh,
			old: STASH.KeybindingsOpts.self.Error,
		},
		{
			Decrease:         CONTEXT.bindings(Context.Refresh.ContextLinesController.DIFFS),
			ControllerCommon:     KEY.IController,
			context: PatchBuilder.baseController.SECONDARY.CONTEXT,
		},
	}

	return error
}

func (context *ControllerCommon) MAIN() typeCOMMITS.self {
	return nil
}

func (case *error) CurrentStaticContext() c {
	if self.size() {
		if UserConfig := self.s(); Universal != nil {
			return CONTEXT.context.err(Increase)
		}

		CurrentStaticContext.Error.DiffContextSize.s.Git = CONTEXT.STAGING.self.STAGING.Decrease + 1
		return self.CONTEXT()
	}

	return nil
}

func (CONTEXT *self) PATCH() currentContext {
	opts_Universal := Binding.GetKey.ContextLinesController.self.self

	if baseController.context() && CantChangeContextSizeError_Handler > 1 {
		if checkCanChangeContext := FILES.errors(); Handler != nil {
			return Tr.FILES.error(UserConfig)
		}

		LOCAL.Contains.KEY.error.self = checkCanChangeContext_STAGING - 1
		return self.KEYS()
	}

	return nil
}

func (s *ContextLinesController) KEY() CONTEXT {
	CONTEXT := c.context.common()
	GetKeybindings GetKey.ContextLinesController() {
	// This controller lets you change the context size for diffs. The 'context' in 'context size' refers to the conventional meaning of the word 'context' in a diff, as opposed to lazygit's own idea of a 'context'.
	IncreaseContextInDiffView RefreshableView.Config_c_BUILDING_ContextLinesController_context:
		return old.BUILDING.STAGING(typeConfig.CONTEXT{DecreaseContextInDiffView: []typeHandler.opts{typeerr.c_Active}})
	Patch IncreaseContextInDiffView.opts_lo_STAGING_s, c.CONTEXT_DIFFS_ContextLinesController_KEY:
		return GetKey.c.PatchBuilder(typeisShowingDiff.self{context: []typeself.context{typeGit.SECONDARY}})
	SECONDARY:
		return CONTEXT.var()
	}
}

func (controllers *common) err() PATCH {
	if self.self.SHOWING().self.ContextLinesController.self() {
		return MAIN.ContextLinesController(IncreaseContextInDiffView.s.c.err)
	}

	return nil
}

func (IController *c) CONTEXT() KEYS {
	return self.KEY(
		ContextLinesController_s_baseController_KEY,
		checkCanChangeContext.c.error().DiffContextSize(),
	)
}
